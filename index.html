<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Registro de Famílias Azannianas</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050505;
  --card:#121212;
  --gold:#d4af37;
  --red:#8b0000;
  --text:#f2f2f2;
  --muted:#8a8a8a;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Segoe UI",sans-serif;
  background:#000;
  color:var(--text);
}

header{
  text-align:center;
  padding:2rem 1rem 1rem;
  font-family:Rockwell,"Cinzel Decorative",serif;
  font-size:2.4rem;
  color:var(--gold);
  border-bottom:1px solid rgba(212,175,55,.4);
}

.tabs{
  display:flex;
  justify-content:center;
  gap:1rem;
  margin:1.5rem 0;
  flex-wrap:wrap;
}

.tabs button{
  background:#0f0f0f;
  color:var(--gold);
  border:1px solid rgba(212,175,55,.4);
  padding:.6rem 1.4rem;
  border-radius:10px;
  font-family:Rockwell;
  cursor:pointer;
}

.tabs button.active{
  background:linear-gradient(135deg,var(--red),var(--gold));
  color:white;
}

#totalCount{
  text-align:center;
  color:var(--muted);
  margin-bottom:1.5rem;
}

.form-container,
.search-container{
  max-width:820px;
  margin:0 auto 1.2rem;
  padding:1rem;
  display:flex;
  flex-wrap:wrap;
  gap:.8rem;
  justify-content:center;
  background:var(--card);
  border-radius:14px;
  border:1px solid rgba(212,175,55,.25);
}

input{
  background:#0c0c0c;
  color:var(--text);
  border:1px solid rgba(212,175,55,.4);
  border-radius:10px;
  padding:.6rem .9rem;
  min-width:200px;
}

button{
  background:linear-gradient(135deg,var(--red),var(--gold));
  color:white;
  border:none;
  padding:.6rem 1.2rem;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.buttons-row{
  display:flex;
  gap:.8rem;
  justify-content:center;
  width:100%;
}

.container{
  max-width:1000px;
  margin:2rem auto;
  padding:0 1rem 3rem;
}

.family-card{
  background:var(--card);
  border-radius:16px;
  padding:1.2rem 1.4rem;
  margin-bottom:1.8rem;
  border:1px solid rgba(212,175,55,.25);
}

.family-card h3{
  margin:0 0 1rem;
  font-family:Rockwell;
  color:var(--gold);
  border-bottom:1px solid rgba(212,175,55,.35);
}

.person-info{
  display:flex;
  justify-content:space-between;
  padding:.55rem 0;
  border-bottom:1px solid #262626;
}

.person-info:last-child{border-bottom:none}

.person-info .id{
  color:var(--gold);
  font-size:.8rem;
}

.birthday-today{
  background:rgba(212,175,55,.15);
  border-left:3px solid var(--gold);
  padding-left:.6rem;
}

.small{
  font-size:.8rem;
  color:var(--muted);
}

.hidden{display:none}

@media (max-width:600px){
  input,button{width:100%}
  .form-container,.search-container{flex-direction:column}
  .buttons-row{flex-direction:column}
}
</style>
</head>

<body>

<header>Registro de Famílias Azannianas</header>

<div class="tabs">
  <button id="tabMembers" class="active">Membros</button>
  <button id="tabBirthdays">Aniversários</button>
  <button id="tabToday">Aniversariantes do Dia</button>
</div>

<p id="totalCount">Total de pessoas: 0</p>

<div class="form-container">
  <input id="personInput" placeholder="Nome Sobrenome">
  <input id="birthdayInput" placeholder="Aniversário (DDMM ou DD/MM)">
  <input id="ageInput" type="number" min="0" placeholder="Idade atual">
  <div class="buttons-row">
    <button type="button" onclick="addPerson()">Adicionar</button>
    <button type="button" onclick="removePerson()">Remover</button>
  </div>
</div>

<div class="search-container">
  <input id="searchInput" placeholder="Buscar por nome, família ou ID">
</div>

<div id="membersView" class="container"></div>
<div id="birthdaysView" class="container hidden"></div>
<div id="todayView" class="container hidden"></div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import {getDatabase,ref,set,onValue} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyCk8lyH30LX3QYClhZWlUXlkb4XdH0RXBU",
 authDomain:"listagem-multiversal.firebaseapp.com",
 databaseURL:"https://listagem-multiversal-default-rtdb.firebaseio.com",
 projectId:"listagem-multiversal",
 storageBucket:"listagem-multiversal.firebasestorage.app",
 messagingSenderId:"30434611532",
 appId:"1:30434611532:web:1d793498b16a820e2d7fe9"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const membersView=document.getElementById("membersView");
const birthdaysView=document.getElementById("birthdaysView");
const todayView=document.getElementById("todayView");
const searchInput=document.getElementById("searchInput");
const totalCount=document.getElementById("totalCount");

const tabMembers=document.getElementById("tabMembers");
const tabBirthdays=document.getElementById("tabBirthdays");
const tabToday=document.getElementById("tabToday");

let families={};

const today=new Date();
const todayKey=String(today.getMonth()+1).padStart(2,"0")+"-"+String(today.getDate()).padStart(2,"0");
const currentYear=today.getFullYear();

searchInput.addEventListener("input",render);

function activateTab(tab){
  [tabMembers,tabBirthdays,tabToday].forEach(t=>t.classList.remove("active"));
  tab.classList.add("active");

  membersView.classList.add("hidden");
  birthdaysView.classList.add("hidden");
  todayView.classList.add("hidden");

  if(tab===tabMembers) membersView.classList.remove("hidden");
  if(tab===tabBirthdays) birthdaysView.classList.remove("hidden");
  if(tab===tabToday) todayView.classList.remove("hidden");

  render();
}

tabMembers.onclick=()=>activateTab(tabMembers);
tabBirthdays.onclick=()=>activateTab(tabBirthdays);
tabToday.onclick=()=>activateTab(tabToday);

function normalizeBirthday(v){
 v=v.replace(/\D/g,"");
 if(v.length!==4) return null;
 const d=+v.slice(0,2),m=+v.slice(2);
 if(d<1||d>31||m<1||m>12) return null;
 return String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0");
}

function updateAgesIfBirthday(){
 let updated=false;
 Object.values(families).forEach(members=>{
  Object.values(members).forEach(p=>{
   if(!p.birthday||p.age==null) return;
   if(p.birthday===todayKey && p.lastAgeUpdate!==currentYear){
    p.age++;
    p.lastAgeUpdate=currentYear;
    updated=true;
   }
  });
 });
 if(updated) set(ref(db,"families"),families);
}

function updateTotal(){
 let t=0;
 Object.values(families).forEach(m=>t+=Object.keys(m).length);
 totalCount.innerText=`Total de pessoas: ${t}`;
}

function recalculateIds() {
  let id = 1;
  const orderedFamilies = Object.keys(families).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  orderedFamilies.forEach(family => {
    const members = families[family];
    const orderedPeople = Object.keys(members).sort((a,b)=>a.localeCompare(b,"pt-BR"));
    orderedPeople.forEach(name => {
      members[name].id = id++;
    });
  });
}

function addPerson() {
  const name = personInput.value.trim();
  const birthday = normalizeBirthday(birthdayInput.value);
  const age = parseInt(ageInput.value, 10);

  if (!name || !birthday || isNaN(age)) return alert("Dados inválidos");

  const family = name.split(" ").at(-1);
  families[family] ??= {};
  families[family][name] = {
    birthday,
    age,
    lastAgeUpdate: currentYear,
    id: 0
  };

  save();
  personInput.value = "";
  birthdayInput.value = "";
  ageInput.value = "";
}

function removePerson(){
 const name=personInput.value.trim();
 if(!name) return;
 for(const f in families){
  if(families[f][name]){
   delete families[f][name];
   if(!Object.keys(families[f]).length) delete families[f];
   save();
   break;
  }
 }
}

function save() {
  recalculateIds();
  set(ref(db,"families"), families);
  updateTotal();
  render();
}

function render(){
 if(tabMembers.classList.contains("active")) return renderMembers();
 if(tabBirthdays.classList.contains("active")) return renderBirthdays();
 if(tabToday.classList.contains("active")) return renderToday();
}

function renderMembers(){
 membersView.innerHTML="";
 const q=searchInput.value.toLowerCase();
 Object.entries(families).forEach(([family,members])=>{
  const list=Object.entries(members).filter(([n,p])=>
   `${n} ${family} ${p.id}`.toLowerCase().includes(q)
  );
  if(!list.length) return;
  const card=document.createElement("div");
  card.className="family-card";
  card.innerHTML=`<h3>${family}</h3>`;
  list.forEach(([n,p])=>{
   const [m,d]=p.birthday.split("-");
   card.innerHTML+=`
    <div class="person-info">
     <div>${n}
      <div class="small">
       ${d}/${m} • ${p.age} anos
      </div>
     </div>
     <div class="id">#${p.id}</div>
    </div>`;
  });
  membersView.appendChild(card);
 });
}

function renderBirthdays(){
 birthdaysView.innerHTML="";
 const people=[];
 Object.entries(families).forEach(([family,members])=>{
  Object.entries(members).forEach(([n,p])=>{
   if(!p.birthday) return;
   const [m,d]=p.birthday.split("-").map(Number);
   people.push({n,family,m,d,age:p.age});
  });
 });
 people.sort((a,b)=>a.m-b.m||a.d-b.d);
 let cm=null,card;
 people.forEach(p=>{
  if(p.m!==cm){
   cm=p.m;
   card=document.createElement("div");
   card.className="family-card";
   card.innerHTML=`<h3>${String(p.m).padStart(2,"0")}</h3>`;
   birthdaysView.appendChild(card);
  }
  const isToday=String(p.m).padStart(2,"0")+"-"+String(p.d).padStart(2,"0")===todayKey;
  card.innerHTML+=`
   <div class="person-info ${isToday?"birthday-today":""}">
    <div>${p.n}
     <div class="small">
      ${String(p.d).padStart(2,"0")}/${String(p.m).padStart(2,"0")} • ${p.family} • ${p.age} anos
     </div>
    </div>
   </div>`;
 });
}

function renderToday(){
 todayView.innerHTML="";
 const people=[];

 Object.entries(families).forEach(([family,members])=>{
  Object.entries(members).forEach(([n,p])=>{
   if(p.birthday===todayKey){
    people.push({n,family,age:p.age,id:p.id});
   }
  });
 });

 if(!people.length){
  todayView.innerHTML=`<div class="family-card"><h3>Nenhum aniversariante hoje</h3></div>`;
  return;
 }

 const card=document.createElement("div");
 card.className="family-card";
 card.innerHTML=`<h3>Aniversariantes de Hoje</h3>`;

 people.sort((a,b)=>a.n.localeCompare(b.n,"pt-BR"));

 people.forEach(p=>{
  card.innerHTML+=`
   <div class="person-info birthday-today">
    <div>${p.n}
     <div class="small">${p.family} • ${p.age} anos</div>
    </div>
    <div class="id">#${p.id}</div>
   </div>`;
 });

 todayView.appendChild(card);
}

onValue(ref(db,"families"),s=>{
 families=s.val()||{};
 updateAgesIfBirthday();
 recalculateIds();
 updateTotal();
 render();
});

window.addPerson=addPerson;
window.removePerson=removePerson;
</script>

</body>
</html>
